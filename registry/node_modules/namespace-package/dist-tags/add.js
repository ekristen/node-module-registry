var pkgdal = require('dal/package')

var auth = require('auth')
var logger = require('logger').child({component: 'namespace-package/dist-tags/add'})

module.exports = function namespaceDisttagsAdd (req, res, next) {
  // TODO: check for tag parameter

  req.package.tag = req.params.tag

  logger.debug({package: req.package}, 'dist-tag add')

  auth.verifyFromDatastore(req, res, 'write', function(err) {
    if (err) {
      //res.statusCode = 401
      //return res.end(JSON.stringify({error: 'unauthorized'}))
      logger.fatal({err: err}, 'auth error')
      return next(err)
    }

    pkgdal.addTag(req.package.id, req.package.tag, req.body, function(err) {
      if (err) {
        //res.statusCode = 500
        //return res.end(JSON.stringify({error: err.message}))
        logger.fatal({err: err}, 'addTag error')
        return next(err)
      }

      res.end()
      return next()
    })
  })
}
