// Installed Modules
var restify = require('restify')

// Local Modules
var dalpkg = require('dal/package')
var logger = require('logger').child({component: 'namespace-package/publish'})

module.exports = function namespacePublish (req, res, next) {
  dalpkg.publish(req.body, req.auth.user, function (err, result) {
    if (err && err.message.indexOf('Cannot publish a version') === 0) {
      logger.warn({package: result}, 'cannot publish an already published version')
      return next(new restify.ConflictError(err))
    }

    if (err) {
      logger.fatal({err: err}, 'dalpkg.publish error')
      return next(err)
    }

    logger.info({package: result}, 'publish successful')

    res.end()
    return next()
  })
}
