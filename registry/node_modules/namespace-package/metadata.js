// Installed Modules
var restify = require('restify')

// Local Modules
var dalpkg = require('dal/package')
var logger = require('logger').child({component: 'namespace-package/metadata'})

module.exports = function namespaceMetadata (req, res, next) {
  req.package.tag = false

  if (typeof req.params.tag !== 'undefined') {
    req.package.tag = req.params.tag
  }

  logger.debug({package: req.package}, 'package info')

  dalpkg.get(req.package.id, function (err, result) {
    if (err) {
      logger.fatal({err: err}, 'dalpkg.get error')
      return next(err)
    }

    if (typeof result._id === 'undefined') {
      logger.info({package: result}, 'package not found')
      return next(new restify.NotFoundError('package not found'))
    }

    if (req.package.tag !== false) {
      if (typeof result['dist-tags'][req.package.tag] === 'undefined') {
        logger.warn({package: result}, 'specific version not found')
        return next(new restify.NotFoundError('specific package version not found'))
      }

      var version_data = result.versions[result['dist-tags'][req.package.tag]]

      logger.info({version: version_data}, 'specific version')

      res.send(version_data)
      return next()
    }

    logger.info({package: result}, 'package found')

    res.send(result)
    return next()
  })
}
